---
title: "FC CovBat using Log Transform"
author:
  - Andrew Chen
  - Advised by Haochang Shou and Taki Shinohara
fontsize: 16pt
always_allow_html: yes
output:
  xaringan::moon_reader:
    css: ["xaringan-themer.css"]
    nature:
      slideNumberFormat: "%current%"
  beamer_presentation:
    theme: "Szeged"
    colortheme: "dolphin"
header_includes: 
  - \usepackage{amsmath}
  - \usepackage{bm}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(reshape2)
library(ggplot2)
library(xaringanthemer)
library(xtable)
library(lessR)
library(tableone)
library(plotly)
library(png)
library(grid)
library(psych)

theme_set(theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()))
options(digits = 4)

load("../../ABCD Example/pris_vs_fit_perm.Rdata")
load("../../BLSA CARDIA Example/cardia_1_4_covout_noPVD.Rdata")
load("../../BLSA CARDIA Example/cardia_fc_norms.Rdata")
source("../../covbat.R", chdir = TRUE)
```

# ABCD Permutation Tests: Model Only
- For simple initial test, permute scanner model only (Prisma and Prisma fit)
    - Compute correlation matrix using all subjects acquired on that model
    - Compare on Frobenius distance
    
```{r fig.width=5, fig.height=5, fig.show='hold', fig.align='center', out.width = "50%"}
hist(type_frob_out, xlim = c(1, 10), main = "", xlab = "Frobenius Distance")
abline(v = type_frob, col = "blue")
```

---

# ABCD Permutation Tests: Model/ID
- Next, we permute scanner ID within scanner model (Prisma and Prisma fit)
    - Fixes number of subjects per site and scanner model of each site to be same as original
    - Compute correlation matrix per site
    - Compare on average Frobenius distance
    
```{r fig.width=5, fig.height=5, fig.show='hold', fig.align='center', out.width = "50%"}
hist(type_id_avg_frob_out, xlim = c(55, 180), main = "", xlab = "Avg. Frobenius Distance")
abline(v = type_id_avg_frob, col = "blue")
```
    
# ABCD Permutation Tests: Considerations
- Instead of average Frobenius distance, could try to compare some sort of matrix mean
    - The usual arithmetic mean is known to perform poorly for matrices
    - Log-Euclidean mean is a viable alternative
- Mean does not seem to accurately capture central tendency
    - Correlation matrices can have mean that is not a correlation matrix
    - Covariance matrices found to have mean that appears 

# Introducing CovBat for Functional Connectivity
- Similar idea as regular CovBat but instead on matrix observations
- Use PVD (Crainiceanu et al. 2011) to reduce dimension of matrices to $A \times A$ before performing PCA

$$\log\Sigma_{ij} = \mathbf{P} \mathbf{V}_{ij} \mathbf{P}^T + \mathbf{E}_{ij}$$

- Vectorize subject-specific matrices then perform PCA to obtain $\boldsymbol{\phi}_k$, which are just the eigenvectors arranged as $A \times A$ symmetric matrices
- Left and right multiply by population-level matrix $P$ to obtain

$$\log\Sigma_{ij} = \sum_{k = 1}^K \Lambda_{ijk} \mathbf{P} \boldsymbol{\phi}_k \mathbf{P}^T + \mathbf{P} \boldsymbol{\eta}_i \mathbf{P}^T + \mathbf{E}_{ij} = \sum_{k = 1}^K \Lambda_{ijk} \mathbf{\Phi}_k + \mathbf{e}_{ij}$$

- Apply ComBat including covariates to the $\Lambda_{ijk}$, harmonizing across sites indexed by $i$
- Recover CovBat-adjusted FC matrices by applying population-level framing, then taking the matrix exponential

---

# FC CovBat Simplification
- Last time, we showed that the PVD model fits the data poorly
- Let's try without the PVD step
    - PVD typically used to reduce dimension for PCA
    - However, PCA is possible with the $264^2 = 69696$-dimensional dataset
    


---

# Cardia 1/4 Dataset
- 196 subjects across two sites

```{r, include=FALSE}
demotab <- CreateTableOne(vars = c("age_at_scan", "sex"), data = all_demo, strata = "site")
tabout <- print(demotab)
```

```{r demo, results="asis"}
print(xtable(tabout[,-7]), comment = FALSE, type = "html")
```

---

# Cardia 1 Subject 1 Covariance
```{r fig.width=10, fig.height=10, fig.show='hold', fig.align='center', out.width = "70%"}
plot_mat(fc_covout$dat.input[,,1])
```

---

# CARDIA 1 Subject 1 Correlation
```{r fig.width=10, fig.height=10, fig.show='hold', fig.align='center', out.width = "70%"}
plot_mat(cov2cor(fc_covout$dat.input[,,1]))
```

---

# CARDIA 1 Subject 1 Log Covariance
```{r fig.width=10, fig.height=10, fig.show='hold', fig.align='center', out.width = "70%"}
plot_mat(fc_covout$dat.log.input[,,1])
```

---

# CARDIA 1 Subject 1 CovBat
```{r fig.width=10, fig.height=10, fig.show='hold', fig.align='center', out.width = "70%"}
plot_mat(cov2cor(fc_covout$dat.covbat[,,1]))
```

---

# Cardia 4 Subject 1 Covariance
```{r fig.width=10, fig.height=10, fig.show='hold', fig.align='center', out.width = "70%"}
plot_mat(fc_covout$dat.input[,,58])
```

---

# CARDIA 1 Subject 1 Correlation
```{r fig.width=10, fig.height=10, fig.show='hold', fig.align='center', out.width = "70%"}
plot_mat(cov2cor(fc_covout$dat.input[,,58]))
```

---

# CARDIA 1 Subject 1 Log Covariance
```{r fig.width=10, fig.height=10, fig.show='hold', fig.align='center', out.width = "70%"}
plot_mat(fc_covout$dat.log.input[,,58])
```

---

# CARDIA 1 Subject 1 CovBat
```{r fig.width=10, fig.height=10, fig.show='hold', fig.align='center', out.width = "70%"}
plot_mat(cov2cor(fc_covout$dat.covbat[,,58]))
```

---

# CARDIA 1 Log-Euclidean Mean Before
```{r fig.width=10, fig.height=10, fig.show='hold', fig.align='center', out.width = "70%"}
plot_mat(expm(rowSums(fc_covout$dat.log.input[,,all_demo$scanner_id==1], dims = 2)/sum(all_demo$scanner_id==1)))
```

---

# CARDIA 4 Log-Euclidean Mean Before
```{r fig.width=10, fig.height=10, fig.show='hold', fig.align='center', out.width = "70%"}
plot_mat(expm(rowSums(fc_covout$dat.log.input[,,all_demo$scanner_id==4], dims = 2)/sum(all_demo$scanner_id==4)))
```

---

# CARDIA 1 Log-Euclidean Mean After CovBat
```{r fig.width=10, fig.height=10, fig.show='hold', fig.align='center', out.width = "70%"}
plot_mat(expm(rowSums(fc_covout$dat.log.covbat[,,all_demo$scanner_id==1], dims = 2)/sum(all_demo$scanner_id==1)))
```

---

# CARDIA 4 Log-Euclidean Mean After CovBat
```{r fig.width=10, fig.height=10, fig.show='hold', fig.align='center', out.width = "70%"}
plot_mat(expm(rowSums(fc_covout$dat.log.covbat[,,all_demo$scanner_id==4], dims = 2)/sum(all_demo$scanner_id==4)))
```

---

# CARDIA 1 Arithmetic Mean Before
```{r fig.width=10, fig.height=10, fig.show='hold', fig.align='center', out.width = "70%"}
plot_mat(rowSums(fc_covout$dat.input[,,all_demo$scanner_id==1], dims = 2)/sum(all_demo$scanner_id==1))
```

---

# CARDIA 4 Arithmetic Mean Before
```{r fig.width=10, fig.height=10, fig.show='hold', fig.align='center', out.width = "70%"}
plot_mat(rowSums(fc_covout$dat.input[,,all_demo$scanner_id==4], dims = 2)/sum(all_demo$scanner_id==4))
```

---

# CARDIA 1 Arithmetic Mean After
```{r fig.width=10, fig.height=10, fig.show='hold', fig.align='center', out.width = "70%"}
plot_mat(rowSums(fc_covout$dat.covbat[,,all_demo$scanner_id==1], dims = 2)/sum(all_demo$scanner_id==1))
```

---

# CARDIA 4 Arithmetic Mean After
```{r fig.width=10, fig.height=10, fig.show='hold', fig.align='center', out.width = "70%"}
plot_mat(rowSums(fc_covout$dat.covbat[,,all_demo$scanner_id==4], dims = 2)/sum(all_demo$scanner_id==4))
```

---

# Still Unexpected Frobenius Norm Results
- For now, evaluate based on mean of all Frobenius norms between those in site A and those in site B
- Goes up for covariance and down for correlation

Covariance
```{r, results="asis"}
print(xtable(site_1_2_cov), comment = FALSE, type = "html")
```

Correlation
```{r, results="asis"}
print(xtable(site_1_2_cor), comment = FALSE, type = "html")
```

---

# PC Score Correction
```{r}
bat <- as.numeric(all_demo$site)

var_in <- rbind(A = apply(fc_covout$x.pc$x[bat==1,], 2, var)[1:5],
                B = apply(fc_covout$x.pc$x[bat==2,], 2, var)[1:5])
var_out <- rbind(A = apply(fc_covout$com.scores$dat.combat[,bat==1], 1, var)[1:5],
                 B = apply(fc_covout$com.scores$dat.combat[,bat==2], 1, var)[1:5])

mean_in <- rbind(A = apply(fc_covout$x.pc$x[bat==1,], 2, mean)[1:5],
                 B = apply(fc_covout$x.pc$x[bat==2,], 2, mean)[1:5])
mean_out <- rbind(A = apply(fc_covout$com.scores$dat.combat[,bat==1], 1, mean)[1:5],
                  B = apply(fc_covout$com.scores$dat.combat[,bat==2], 1, mean)[1:5])
```

Score Variance Before

```{r, results="asis"}
print(xtable(var_in), comment = FALSE, type = "html")
```

Score Variance After

```{r, results="asis"}
print(xtable(var_out), comment = FALSE, type = "html")
```

---

# PC Score Correction

Score Mean Before

```{r, results="asis"}
print(xtable(mean_in), comment = FALSE, type = "html")
```

Score Mean After

```{r, results="asis"}
print(xtable(mean_out), comment = FALSE, type = "html")
```
